<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatAI</title>
    <link rel="icon" href="chat-ai-favicon.ico" type="image/x-icon">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-image: url('fiscozen-frontoffice.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>

    <script>
      // Set the custom identifier before the Unless snippet loads
      window.TxtOptions = { customIdentifier: '555' };
    </script>


    <script data-unless='1.2' data-installer='snippet'>
      !function(o,p,t,i,m,a,l){function s(e){o.documentElement.style.opacity=e}function d(e){i.parentNode.insertBefore(e,i)}
      s((window.TxtOptions||{}).asyncMode?"":0),setTimeout(function(){s("")},3e3),
      i=(o.head||o.documentElement).firstChild,l="https://"+t+".unless.com/js/v5/latest/txt.min.js?id="+t+"&domain="+window.location.hostname,
      (m=o.createElement("link")).href=l,m.rel="preconnect preload",m.as=p,d(m),
      (a=o.createElement(p)).src=l,d(a),a.onerror=function(){s("")}
      }(document,"script","802f9be4-64b4-4731-81a3-b85ec2d1fc22");
    </script>

</head>
<body>
    <!-- 
      This is the recommended Freshchat implementation.
      1. It sets the externalId on init to prevent user conflicts.
      2. It uses the widget:loaded event to know when the API is ready.
      3. It checks if the user already exists before setting properties.
      4. It captures the restoreId for new users to maintain conversation history.
    -->

    <!-- Freshchat Configuration -->
    <script>
      // In a real application, you would fetch this from your database for the logged-in user.
      var restoreId = null; 

      window.fcWidgetMessengerConfig = {
        externalId: "555",      // User's unique ID in your system
        restoreId: "db4f8ad9-cc50-4858-9489-2e3154f89b36" //restoreId ? restoreId : null
      };
    </script>

    <!-- Freshchat Widget Script -->
    <script src='//eu.fw-cdn.com/13069928/1021706.js' chat='true'></script>

    <!-- Freshchat User Initialization & Unless Profile Update Script -->
    <script>
      window.fwcrm.on('widget:loaded', function() {
        console.log("Freshchat widget:loaded event fired.");

        // --- Update Unless Profile ---
        // We wait for the 'Txt' object from Unless to be ready before calling it.
        function updateUnlessProfile() {
            if (typeof Txt !== 'undefined' && Txt.updateProfile) {
                console.log("Unless API is ready. Updating profile for user 555...");
                Txt.updateProfile([
                    {key: 'user_id', value: '555', type: 'text', custom: true},
                    {key: 'firstName', value: 'Chris', type: 'text', custom: true},
                    {key: 'lastName', value: 'Martin', type: 'text', custom: true},
                    {key: 'email', value: 'chris.martin@fiscozen.it', type: 'text', custom: true},
                    {key: 'phone', value: '+44555', type: 'text', custom: true},
                    {key: 'payment_status', value: 'active', type: 'text', custom: true},
                    {key: 'fiscal_regime', value: 'Forfettario', type: 'text', custom: true},
                    {key: 'welfare_institution', value: 'GS INPS', type: 'text', custom: true},
                    {key: 'ateco_1', value: '73.11.02', type: 'text', custom: true},
                    {key: 'ssn', value: 'CHRIS', type: 'text', custom: true},
                    {key: 'consultant_squad_id', value: '01-Amelis', type: 'text', custom: true}
                ]);
            } else {
                // If Unless script isn't ready, wait 100ms and try again
                setTimeout(updateUnlessProfile, 100);
            }
        }
        updateUnlessProfile(); // Start the process

        // --- Freshchat User Initialization ---
        window.fcWidget.user.get(function(resp) {
          var status = resp && resp.status;
          var data = resp && resp.data;

          // user.get() returns a non-200 status if the user doesn't exist yet.
          if (status !== 200) {
            console.log("User not found on Freshchat, creating new user...");
            window.fcWidget.user.setProperties({
              firstName: "Chris",
              lastName: "Martin",
              email: "chris.martin@fiscozen.it",
              phone: "+44555",
              // Custom properties
              payment_status: "active",
              fiscal_regime: "Forfettario",
              welfare_institution: "GS INPS",
              ateco_1: "73.11.02",
              ssn: "CHRIS",
              consultant_squad_id: "01-Amelis"
            });

            // Listen for the user:created event to get the new restoreId
            window.fcWidget.on('user:created', function(resp) {
              var status = resp && resp.status;
              var data = resp && resp.data;
              console.log(status);
              console.log(data);
              if (status === 200 && data.restoreId) {
                console.log("User created successfully. New restoreId:", data.restoreId);
                // In a real application, you would now save this data.restoreId to your database.
              }
            });

          } else {
            console.log("Existing user found on Freshchat, session restored. Status:", status);
          }

          // Always open the widget
          window.fcWidget.open();
          console.log("Widget opened automatically.");
        });
      }); 
    </script>
</body>
</html>
