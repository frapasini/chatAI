<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatAI</title>
    <link rel="icon" href="chat-ai-favicon.ico" type="image/x-icon">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-image: url('fiscozen-frontoffice.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body>
    <!-- 
      This is the recommended Freshchat implementation.
      1. It sets the externalId on init to prevent user conflicts.
      2. It uses the widget:loaded event to know when the API is ready.
      3. It checks if the user already exists before setting properties.
      4. It captures the restoreId for new users to maintain conversation history.
    -->

    <!-- Freshchat Configuration -->
    <script>
      // In a real application, you would fetch this from your database for the logged-in user.
      var restoreId = null; 

      window.fcWidgetMessengerConfig = {
        externalId: "161091",      // User's unique ID in your system
        restoreId: restoreId ? restoreId : null
      };
    </script>

    <!-- Freshchat Widget Script -->
    <script src='//eu.fw-cdn.com/13069928/1021706.js' chat='true'></script>

    <!-- Freshchat User Initialization Script -->
    <script>
      window.fwcrm.on('widget:loaded', function() {
        console.log("Freshchat widget:loaded event fired.");

        window.fcWidget.user.get(function(resp) {
          var status = resp && resp.status;
          var data = resp && resp.data;

          if (status !== 200) {
            console.log("User not found on Freshchat, creating new user...");
            window.fcWidget.user.setProperties({
              firstName: "Mario",
              lastName: "Rossi",
              email: "mario.rossi@fiscozen.it",
              phone: "+393456789012",
              // Custom properties
              payment_status: "active",
              fiscal_regime: "Forfettario",
              welfare_institution: "GS INPS",
              ateco_1: "73.11.02",
              ssn: "RSSMRA85M01H501Z",
              consultant_squad_id: "01-Amelis"
            });

            // Listen for the user:created event to get the new restoreId
            window.fcWidget.on('user:created', function(resp) {
              var status = resp && resp.status;
              var data = resp && resp.data;
              if (status === 200 && data.restoreId) {
                console.log("User created successfully. New restoreId:", data.restoreId);
                // In a real application, you would now save this data.restoreId to your database.
              }
            });

          } else {
            console.log("Existing user found on Freshchat, session restored. Status:", status);
          }

          // Always open the widget
          window.fcWidget.open();
          console.log("Widget opened automatically.");
        });
      }); 
    </script>
</body>
</html>
